<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teleprompter</title>
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: #000;
            color: #fff;
            font-family: 'Arial', 'Helvetica', sans-serif;
            overflow: hidden;
            height: 100vh;
        }
        
        .teleprompter-container {
            position: relative;
            height: 100vh;
            width: 100%;
        }
        
        .script-content {
            position: absolute;
            left: 0;
            right: 0;
            padding: 40px 60px;
            font-size: 16px;
            line-height: 1.6;
            text-align: left;
            max-width: 1000px;
            margin: 0 auto;
            font-weight: 400;
            letter-spacing: 0.5px;
            width: 100%;
            box-sizing: border-box;
        }
        
        /* Override max-width on mobile devices */
        @media (max-width: 768px) {
            .script-content {
                max-width: 100vw !important;
                margin: 0 !important;
                padding: 20px 15px !important;
                width: 100vw !important;
                left: 0 !important;
                right: 0 !important;
            }
        }
        
        @media (max-width: 480px) {
            .script-content {
                max-width: 100vw !important;
                margin: 0 !important;
                padding: 15px 10px !important;
                width: 100vw !important;
                left: 0 !important;
                right: 0 !important;
                line-height: 1.4;
            }
        }
        
        .script-content h1 {
            font-size: 1.5em;
            margin: 40px 0;
            font-weight: bold;
        }
        
        .script-content h2 {
            font-size: 1.3em;
            margin: 30px 0 20px 0;
            font-weight: bold;
        }
        
        .script-content p {
            margin: 20px 0;
        }
        
        .controls {
            position: fixed;
            top: 5px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            font-family: Arial, sans-serif;
            font-size: 14px;
            z-index: 1000;
            transition: opacity 0.3s ease;
        }
        
        .upload-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .upload-btn:hover {
            background: #45a049;
        }
        
        .github-link {
            color: #ccc;
            text-decoration: none;
            font-size: 11px;
            transition: color 0.3s ease;
        }
        
        .github-link:hover {
            color: #fff;
            text-decoration: underline;
        }
        
        .controls.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .control-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }
        
        .control-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .control-center {
            flex: 1;
            text-align: center;
        }
        
        .control-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }
        
        .control-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status {
            color: #4CAF50;
            font-weight: bold;
        }
        
        .speed-display {
            color: #2196F3;
            font-weight: bold;
            min-width: 60px;
        }
        
        .font-size-display {
            color: #FF9800;
            font-weight: bold;
            min-width: 60px;
        }
        
        .instructions {
            font-size: 12px;
            color: #ccc;
        }
        
        .instructions-sub {
            font-size: 10px;
            color: #999;
            margin-top: 4px;
        }
        
        button {
            background: #333;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }
        
        button:hover {
            background: #555;
        }
        
        .reading-line {
            position: fixed;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background: rgba(76, 175, 80, 0.5);
            z-index: 500;
            transform: translateY(-1px);
        }
        
        /* Touch D-Pad Styles */
        .touch-dpad {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 150px;
            height: 150px;
            z-index: 1001;
            display: none;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }
        
        .touch-dpad.visible {
            display: block;
        }
        
        .dpad-button {
            position: absolute;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.1s ease;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .dpad-button:active {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(0.95);
        }
        
        .dpad-up {
            top: 0;
            left: 50px;
            width: 50px;
            height: 50px;
            border-radius: 25px 25px 5px 5px;
        }
        
        .dpad-down {
            bottom: 0;
            left: 50px;
            width: 50px;
            height: 50px;
            border-radius: 5px 5px 25px 25px;
        }
        
        .dpad-left {
            left: 0;
            top: 50px;
            width: 50px;
            height: 50px;
            border-radius: 25px 5px 5px 25px;
        }
        
        .dpad-right {
            right: 0;
            top: 50px;
            width: 50px;
            height: 50px;
            border-radius: 5px 25px 25px 5px;
        }
        
        .dpad-center {
            top: 50px;
            left: 50px;
            width: 50px;
            height: 50px;
            border-radius: 25px;
            background: rgba(76, 175, 80, 0.2);
            border-color: rgba(76, 175, 80, 0.5);
        }
        
        .dpad-center:active {
            background: rgba(76, 175, 80, 0.4);
        }
        
        /* Touch feedback */
        .touch-feedback {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px 30px;
            border-radius: 10px;
            font-size: 24px;
            font-weight: bold;
            z-index: 2000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .touch-feedback.show {
            opacity: 1;
        }
        
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }
            
            .control-group {
                justify-content: center;
            }
            
            .touch-dpad {
                display: block;
            }
        }
        
        /* Additional breakpoint for very narrow screens */
        @media (max-width: 480px) {
            
            .controls {
                left: 10px;
                right: 10px;
                padding: 6px 10px;
                font-size: 12px;
            }
            
            .touch-dpad {
                width: 120px;
                height: 120px;
                bottom: 15px;
                right: 15px;
            }
            
            .dpad-button {
                font-size: 16px;
            }
            
            .dpad-up, .dpad-down, .dpad-left, .dpad-right, .dpad-center {
                width: 40px;
                height: 40px;
            }
            
            .dpad-up {
                left: 40px;
            }
            
            .dpad-down {
                left: 40px;
            }
            
            .dpad-left {
                top: 40px;
            }
            
            .dpad-right {
                top: 40px;
            }
            
            .dpad-center {
                top: 40px;
                left: 40px;
            }
        }
        
        /* Detect touch devices */
        @media (hover: none) and (pointer: coarse) {
            .touch-dpad {
                display: block;
            }
        }
    </style>
</head>
<body>
    <div class="teleprompter-container">
        <div class="controls" id="controls">
            <div class="control-row">
                <div class="control-left">
                    <span>Font: <span id="font-size-display">16px</span></span>
                    <span>Speed: <span id="speed-display">1.0x</span></span>
                    <span>Status: <span id="status">Stopped</span></span>
                </div>
                <div class="control-center">
                    <div class="instructions">
                        ← → Font Size | ↑ ↓ Speed | Space Play/Pause | H Hide
                    </div>
                    <div class="instructions-sub">
                        Hold ↑ ↓ for RW/FF
                    </div>
                </div>
                <div class="control-right">
                    <button id="uploadScriptBtn" class="upload-btn">Upload Script</button>
                    <a href="https://github.com/seanblanchfield/teleprompter" target="_blank" class="github-link">GitHub</a>
                </div>
            </div>
        </div>
        
        <div class="reading-line"></div>
        
        <div class="script-content" id="script-content">
            <div id="loading-message">Loading script...</div>
            <div style="height: 100vh;"></div>
        </div>
        
        <!-- Touch D-Pad -->
        <div class="touch-dpad" id="touch-dpad">
            <div class="dpad-button dpad-up" id="dpad-up">▲</div>
            <div class="dpad-button dpad-down" id="dpad-down">▼</div>
            <div class="dpad-button dpad-left" id="dpad-left">-</div>
            <div class="dpad-button dpad-right" id="dpad-right">+</div>
            <div class="dpad-button dpad-center" id="dpad-center">▶</div>
        </div>
        
        <!-- Touch Feedback -->
        <div class="touch-feedback" id="touch-feedback"></div>
    </div>

    <script>
        // Teleprompter State
        let isScrolling = false;
        let scrollSpeed = 1.0;
        let fontSize = 16;
        let animationId = null;
        let controlsVisible = true;
        let hideTimeout = null;
        
        // Predefined font sizes (16px to 144px with full granularity)
        const fontSizes = [16, 18, 20, 22, 24, 26, 28, 30, 32, 34, 36, 38, 40, 42, 44, 46, 48, 50, 52, 54, 56, 58, 60, 62, 64, 66, 68, 70, 72, 74, 76, 78, 80, 82, 84, 86, 88, 90, 92, 94, 96, 98, 100, 102, 104, 106, 108, 110, 112, 114, 116, 118, 120, 122, 124, 126, 128, 130, 132, 134, 136, 138, 140, 142, 144];
        let currentFontSizeIndex = fontSizes.indexOf(16) !== -1 ? fontSizes.indexOf(16) : 0; // Default to 16px
        
        // Fast forward / rewind state
        let originalSpeed = 1.0;
        let isLongPressing = false;
        let longPressTimeout = null;
        let lastAction = null; // Track whether last long press was 'ff' or 'rw'
        const longPressDelay = 500; // 500ms to trigger long press
        const ffSpeed = 3.0; // Fast forward speed
        const rwSpeed = -2.0; // Rewind speed (negative for reverse)
        
        // Touch state
        let touchStartY = 0;
        let touchStartX = 0;
        let isTouchScrolling = false;
        let touchFeedbackTimeout = null;
        let touchLongPressTimeout = null;
        let isTouchDevice = false;
        
        // DOM Elements
        const scriptContent = document.getElementById('script-content');
        const statusElement = document.getElementById('status');
        const speedDisplay = document.getElementById('speed-display');
        const fontSizeDisplay = document.getElementById('font-size-display');
        const controlsElement = document.getElementById('controls');
        const touchDpad = document.getElementById('touch-dpad');
        const touchFeedback = document.getElementById('touch-feedback');
        
        // Detect touch device
        function detectTouchDevice() {
            isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
            if (isTouchDevice) {
                touchDpad.classList.add('visible');
            }
        }
        
        // Set proper initial position for mobile devices
        function setInitialPosition() {
            const isMobile = window.innerWidth <= 768;
            if (isMobile) {
                // On mobile, start with text at the top of the viewport
                scriptContent.style.top = '80px';
            } else {
                // On desktop, use the original position
                scriptContent.style.top = '180px';
            }
        }
        
        // Force show D-pad for testing (remove this in production)
        function forceShowDpad() {
            touchDpad.classList.add('visible');
        }
        
        // Load script from localStorage, external file, or show upload option
        function loadScript() {
            // Check localStorage first
            const savedScript = localStorage.getItem('teleprompterScript');
            if (savedScript) {
                const html = convertMarkdownToHTML(savedScript);
                scriptContent.innerHTML = html + '<div style="height: 100vh;"></div>';
                setInitialPosition();
                return;
            }
            
            // Create a file input element (hidden)
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.md,.txt';
            fileInput.style.display = 'none';
            document.body.appendChild(fileInput);
            
            // Add manual file selection button
            const loadButton = document.createElement('button');
            loadButton.textContent = 'Load Script File';
            loadButton.style.cssText = 'position: fixed; top: 100px; left: 50%; transform: translateX(-50%); z-index: 1001; padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;';
            loadButton.onclick = () => fileInput.click();
            
            fileInput.onchange = function(event) {
                const file = event.target.files[0];
                if (file && (file.name.endsWith('.md') || file.name.endsWith('.txt'))) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const content = e.target.result;
                        // Save to localStorage
                        localStorage.setItem('teleprompterScript', content);
                        const html = convertMarkdownToHTML(content);
                        scriptContent.innerHTML = html + '<div style="height: 100vh;"></div>';
                        setInitialPosition();
                        loadButton.remove();
                    };
                    reader.readAsText(file);
                }
            };
            
            // Try to load README.md automatically first
            loadScriptFromURL(loadButton);
        }
        
        // Try to load README.md via URL (works with web server)
        async function loadScriptFromURL(loadButton) {
            try {
                // Try README.md (for GitHub Pages and web servers)
                const response = await fetch('README.md');
                const markdown = await response.text();
                const html = convertMarkdownToHTML(markdown);
                scriptContent.innerHTML = html + '<div style="height: 100vh;"></div>';
                setInitialPosition();
                loadButton.remove();
                // Auto-load succeeded
            } catch (error) {
                // Show built-in default content for local file access
                showDefaultContent();
            }
        }
        
        // Show built-in default content
        function showDefaultContent() {
            const defaultContent = `# Teleprompter

Click **"Upload Script"** above to load your own script (.md or .txt files).

## Controls

- **F5** - Play
- **ESC** - Stop
- **Period (.)** - Change font size
- **Page Up/Down** - Speed control

Press **F11** for full-screen mode.`;
            
            const html = convertMarkdownToHTML(defaultContent);
            scriptContent.innerHTML = html + '<div style="height: 100vh;"></div>';
            setInitialPosition();
        }

        // Markdown to HTML converter using marked.js
        function convertMarkdownToHTML(markdown) {
            return marked.parse(markdown);
        }

        // Upload script function for button
        function uploadScript() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.md,.txt';
            fileInput.style.display = 'none';
            document.body.appendChild(fileInput);
            
            fileInput.onchange = function(event) {
                const file = event.target.files[0];
                if (file && (file.name.endsWith('.md') || file.name.endsWith('.txt'))) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const content = e.target.result;
                        // Save to localStorage
                        localStorage.setItem('teleprompterScript', content);
                        const html = convertMarkdownToHTML(content);
                        scriptContent.innerHTML = html + '<div style="height: 100vh;"></div>';
                        // Reset position without clearing localStorage or reloading
                        isScrolling = false;
                        if (animationId) {
                            cancelAnimationFrame(animationId);
                        }
                        setInitialPosition();
                        updateDisplays();
                        updateControlsVisibility();
                    };
                    reader.readAsText(file);
                }
                document.body.removeChild(fileInput);
            };
            
            fileInput.click();
        }
        
        // Add event listener for upload button
        document.getElementById('uploadScriptBtn').addEventListener('click', uploadScript);

        // Update center button icon based on play state
        function updateCenterButtonIcon() {
            const centerButton = document.getElementById('dpad-center');
            if (centerButton) {
                if (isScrolling) {
                    centerButton.innerHTML = '⏸'; // Pause icon
                } else {
                    centerButton.innerHTML = '▶'; // Play icon
                }
            }
        }
        
        // Add visual feedback to D-pad buttons for keyboard presses
        function activateDpadButton(buttonId) {
            const button = document.getElementById(buttonId);
            if (button) {
                button.classList.add('active');
                // Use the same visual effect as :active pseudo-class
                button.style.background = 'rgba(255, 255, 255, 0.3)';
                button.style.transform = 'scale(0.95)';
            }
        }
        
        function deactivateDpadButton(buttonId) {
            const button = document.getElementById(buttonId);
            if (button) {
                button.classList.remove('active');
                button.style.background = '';
                button.style.transform = '';
            }
        }
        
        // Touch feedback function
        function showTouchFeedback(message) {
            touchFeedback.textContent = message;
            touchFeedback.classList.add('show');
            
            clearTimeout(touchFeedbackTimeout);
            touchFeedbackTimeout = setTimeout(() => {
                touchFeedback.classList.remove('show');
            }, 1000);
        }
        
        // Touch D-Pad event handlers
        function setupTouchDpad() {
            const dpadUp = document.getElementById('dpad-up');
            const dpadDown = document.getElementById('dpad-down');
            const dpadLeft = document.getElementById('dpad-left');
            const dpadRight = document.getElementById('dpad-right');
            const dpadCenter = document.getElementById('dpad-center');
            
            // Helper function to handle button actions
            function handleButtonAction(action, feedbackMessage) {
                switch(action) {
                    case 'speed-up':
                        adjustSpeed(0.2);
                        break;
                    case 'speed-down':
                        adjustSpeed(-0.2);
                        break;
                    case 'font-smaller':
                        adjustFontSize(-2);
                        break;
                    case 'font-larger':
                        adjustFontSize(2);
                        break;
                    case 'play-pause':
                        toggleScrolling();
                        break;
                }
                showTouchFeedback(feedbackMessage);
            }
            
            
            // Up button - decrease speed (visually matches slowing down scroll)
            dpadUp.addEventListener('touchstart', (e) => {
                e.preventDefault();
                handleButtonAction('speed-down', `Speed: ${Math.max(0.1, scrollSpeed - 0.2).toFixed(1)}x`);
                
                // Long press for rewind
                touchLongPressTimeout = setTimeout(() => {
                    startLongPress('rw');
                    showTouchFeedback('Rewind');
                }, longPressDelay);
            });
            
            dpadUp.addEventListener('touchend', (e) => {
                e.preventDefault();
                clearTimeout(touchLongPressTimeout);
                endLongPress();
            });
            
            // Add click fallback for desktop testing
            dpadUp.addEventListener('click', (e) => {
                e.preventDefault();
                handleButtonAction('speed-down', `Speed: ${Math.max(0.1, scrollSpeed - 0.2).toFixed(1)}x`);
            });
            
            // Down button - increase speed (visually matches speeding up scroll)
            dpadDown.addEventListener('touchstart', (e) => {
                e.preventDefault();
                handleButtonAction('speed-up', `Speed: ${(scrollSpeed + 0.2).toFixed(1)}x`);
                
                // Long press for fast forward
                touchLongPressTimeout = setTimeout(() => {
                    startLongPress('ff');
                    showTouchFeedback('Fast Forward');
                }, longPressDelay);
            });
            
            dpadDown.addEventListener('touchend', (e) => {
                e.preventDefault();
                clearTimeout(touchLongPressTimeout);
                endLongPress();
            });
            
            // Add click fallback for desktop testing
            dpadDown.addEventListener('click', (e) => {
                e.preventDefault();
                handleButtonAction('speed-up', `Speed: ${(scrollSpeed + 0.2).toFixed(1)}x`);
            });
            
            // Left button - decrease font size
            dpadLeft.addEventListener('touchstart', (e) => {
                e.preventDefault();
                handleButtonAction('font-smaller', `Font: ${Math.max(16, fontSize - 2)}px`);
            });
            
            dpadLeft.addEventListener('touchend', (e) => {
                e.preventDefault();
            });
            
            // Add click fallback for desktop testing
            dpadLeft.addEventListener('click', (e) => {
                e.preventDefault();
                handleButtonAction('font-smaller', `Font: ${Math.max(16, fontSize - 2)}px`);
            });
            
            // Right button - increase font size
            dpadRight.addEventListener('touchstart', (e) => {
                e.preventDefault();
                handleButtonAction('font-larger', `Font: ${Math.min(144, fontSize + 2)}px`);
            });
            
            dpadRight.addEventListener('touchend', (e) => {
                e.preventDefault();
            });
            
            // Add click fallback for desktop testing
            dpadRight.addEventListener('click', (e) => {
                e.preventDefault();
                handleButtonAction('font-larger', `Font: ${Math.min(144, fontSize + 2)}px`);
            });
            
            // Center button - play/pause
            dpadCenter.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const newState = isScrolling ? 'Paused' : 'Playing';
                handleButtonAction('play-pause', newState);
                updateCenterButtonIcon();
            });
            
            dpadCenter.addEventListener('touchend', (e) => {
                e.preventDefault();
            });
            
            // Add click fallback for desktop testing
            dpadCenter.addEventListener('click', (e) => {
                e.preventDefault();
                const newState = isScrolling ? 'Paused' : 'Playing';
                handleButtonAction('play-pause', newState);
                updateCenterButtonIcon();
            });
        }
        
        // Touch drag scrolling
        function setupTouchScrolling() {
            scriptContent.addEventListener('touchstart', (e) => {
                if (e.touches.length === 1) {
                    touchStartY = e.touches[0].clientY;
                    touchStartX = e.touches[0].clientX;
                    isTouchScrolling = false;
                    
                    // Pause automatic scrolling during touch
                    if (isScrolling) {
                        wasScrollingBeforeManual = true;
                        isScrolling = false;
                    }
                }
            });
            
            scriptContent.addEventListener('touchmove', (e) => {
                if (e.touches.length === 1) {
                    e.preventDefault();
                    
                    const touchY = e.touches[0].clientY;
                    const touchX = e.touches[0].clientX;
                    const deltaY = touchY - touchStartY;
                    const deltaX = touchX - touchStartX;
                    
                    // Only scroll if primarily vertical movement
                    if (Math.abs(deltaY) > Math.abs(deltaX) && Math.abs(deltaY) > 10) {
                        isTouchScrolling = true;
                        
                        const currentTop = parseFloat(scriptContent.style.top) || 180;
                        const scrollSensitivity = 1.5;
                        const newTop = currentTop + (deltaY * scrollSensitivity);
                        
                        scriptContent.style.top = newTop + 'px';
                        touchStartY = touchY;
                    }
                }
            });
            
            scriptContent.addEventListener('touchend', (e) => {
                if (isTouchScrolling) {
                    // Resume automatic scrolling after 2 seconds
                    setTimeout(() => {
                        if (wasScrollingBeforeManual) {
                            isScrolling = true;
                            wasScrollingBeforeManual = false;
                            scroll();
                        }
                    }, 2000);
                }
                isTouchScrolling = false;
            });
        }
        
        // Initialize
        detectTouchDevice();
        forceShowDpad(); // Force show for testing - remove in production
        adjustSpeedForFontSize(); // Set speed based on initial font size
        adjustMarginsForFontSize(); // Set initial margins
        updateDisplays();
        updateControlsVisibility();
        adjustReadingLineThickness(); // Set initial line thickness
        setupTouchDpad();
        setupTouchScrolling();
        loadScript();
        
        // Animation function
        function scroll() {
            if (isScrolling) {
                const currentTop = parseFloat(scriptContent.style.top);
                const safeCurrentTop = isNaN(currentTop) ? 180 : currentTop;
                
                // Set initial position if not set
                if (!scriptContent.style.top) {
                    setInitialPosition();
                    return;
                }
                
                const newTop = safeCurrentTop - (scrollSpeed * 0.5);
                
                
                scriptContent.style.top = newTop + 'px';
                
                // Check if we've scrolled past the end (add buffer to ensure full scroll)
                const scrollBuffer = window.innerHeight;
                if (newTop < -(scriptContent.offsetHeight + scrollBuffer)) {
                    isScrolling = false;
                    if (animationId) {
                        cancelAnimationFrame(animationId);
                    }
                    updateDisplays();
                    return;
                }
                
                animationId = requestAnimationFrame(scroll);
            }
        }
        
        // Control functions
        function toggleScrolling() {
            isScrolling = !isScrolling;
            if (isScrolling) {
                scroll();
            } else if (animationId) {
                cancelAnimationFrame(animationId);
            }
            updateDisplays();
            updateControlsVisibility();
        }
        
        function resetScript() {
            isScrolling = false;
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
            setInitialPosition();
            
            // Clear saved script from localStorage and reload default
            localStorage.removeItem('teleprompterScript');
            loadScript();
            
            updateDisplays();
            updateControlsVisibility();
        }
        
        function adjustSpeed(delta) {
            scrollSpeed = Math.max(0.1, Math.min(5.0, scrollSpeed + delta));
            // Update originalSpeed to track user-set speed changes
            if (!isLongPressing) {
                originalSpeed = scrollSpeed;
            }
            updateDisplays();
        }
        
        function adjustFontSize(delta) {
            fontSize = Math.max(16, Math.min(144, fontSize + delta));
            scriptContent.style.fontSize = fontSize + 'px';
            adjustMarginsForFontSize();
            adjustReadingLineThickness();
            adjustSpeedForFontSize();
            updateDisplays();
        }
        
        function cycleFontSize() {
            currentFontSizeIndex = (currentFontSizeIndex + 1) % fontSizes.length;
            fontSize = fontSizes[currentFontSizeIndex];
            scriptContent.style.fontSize = fontSize + 'px';
            adjustMarginsForFontSize();
            adjustReadingLineThickness();
            adjustSpeedForFontSize();
            updateDisplays();
        }
        
        function increaseFontSize() {
            // Calculate relative position before changing font size
            const currentTop = parseFloat(scriptContent.style.top) || 180;
            const viewportCenter = window.innerHeight / 2;
            const relativePosition = (viewportCenter - currentTop) / scriptContent.offsetHeight;
            
            fontSize += 10;
            if (fontSize > 146) {
                fontSize = 16; // Wrap back to 16px after 146px
            }
            scriptContent.style.fontSize = fontSize + 'px';
            adjustMarginsForFontSize();
            adjustReadingLineThickness();
            adjustSpeedForFontSize();
            
            // Wait for layout to update, then restore relative position
            requestAnimationFrame(() => {
                const newHeight = scriptContent.offsetHeight;
                const newTop = viewportCenter - (relativePosition * newHeight);
                scriptContent.style.top = newTop + 'px';
            });
            
            updateDisplays();
        }
        
        function adjustMarginsForFontSize() {
            // Progressive margin scaling from 16px to 144px
            // 16px font = 200px margins, 144px font = 10px margins
            const minFontSize = 16;
            const maxFontSize = 144;
            const maxMargin = 200;
            const minMargin = 10;
            
            const clampedFontSize = Math.max(minFontSize, Math.min(maxFontSize, fontSize));
            const margin = maxMargin - (clampedFontSize - minFontSize) * (maxMargin - minMargin) / (maxFontSize - minFontSize);
            // Don't round - use precise values for smooth transitions
            const preciseMargin = Math.max(minMargin, margin);
            
            scriptContent.style.padding = `40px ${preciseMargin}px`;
            
            // Progressive max-width scaling - also use precise calculations
            let maxWidth;
            if (fontSize <= 50) {
                // Linear interpolation for max-width too
                const widthMin = 800;
                const widthMax = 1000;
                const fontMin = 16;
                const fontMax = 50;
                const width = widthMin + (fontSize - fontMin) * (widthMax - widthMin) / (fontMax - fontMin);
                maxWidth = Math.round(width) + 'px';
            } else if (fontSize <= 100) {
                const widthMin = 1000;
                const widthMax = 1400;
                const fontMin = 50;
                const fontMax = 100;
                const width = widthMin + (fontSize - fontMin) * (widthMax - widthMin) / (fontMax - fontMin);
                maxWidth = Math.round(width) + 'px';
            } else {
                maxWidth = 'none';
            }
            scriptContent.style.maxWidth = maxWidth;
        }
        
        function adjustReadingLineThickness() {
            // Scale line thickness with font size
            // 32px font = 2px line, 144px font = 8px line
            const minFontSize = 32;
            const maxFontSize = 144;
            const minThickness = 2;
            const maxThickness = 8;
            
            const clampedFontSize = Math.max(minFontSize, Math.min(maxFontSize, fontSize));
            const thickness = minThickness + (clampedFontSize - minFontSize) * (maxThickness - minThickness) / (maxFontSize - minFontSize);
            const roundedThickness = Math.round(thickness);
            
            const readingLine = document.querySelector('.reading-line');
            if (readingLine) {
                readingLine.style.height = roundedThickness + 'px';
                readingLine.style.transform = `translateY(-${Math.floor(roundedThickness / 2)}px)`;
            }
        }
        
        function adjustSpeedForFontSize() {
            // Extended speed scaling: 16px = 0.5, 32px = 0.3, 72px = 0.9, 144px = 1.5
            let speed;
            if (fontSize <= 32) {
                // Handle small fonts: 16px = 0.5 speed, 32px = 0.3 speed
                const minFontSize = 16;
                const maxFontSize = 32;
                const minSpeed = 0.5;
                const maxSpeed = 0.3;
                
                const clampedFontSize = Math.max(minFontSize, Math.min(maxFontSize, fontSize));
                speed = minSpeed + (clampedFontSize - minFontSize) * (maxSpeed - minSpeed) / (maxFontSize - minFontSize);
            } else if (fontSize <= 72) {
                // Original range: 32px = 0.3 speed, 72px = 0.9 speed
                const minFontSize = 32;
                const maxFontSize = 72;
                const minSpeed = 0.3;
                const maxSpeed = 0.9;
                
                const clampedFontSize = Math.max(minFontSize, Math.min(maxFontSize, fontSize));
                speed = minSpeed + (clampedFontSize - minFontSize) * (maxSpeed - minSpeed) / (maxFontSize - minFontSize);
            } else {
                // Extended range: 72px = 0.9 speed, 144px = 1.5 speed
                const minFontSize = 72;
                const maxFontSize = 144;
                const minSpeed = 0.9;
                const maxSpeed = 1.5;
                
                const clampedFontSize = Math.max(minFontSize, Math.min(maxFontSize, fontSize));
                speed = minSpeed + (clampedFontSize - minFontSize) * (maxSpeed - minSpeed) / (maxFontSize - minFontSize);
            }
            
            scrollSpeed = Math.round(speed * 100) / 100; // Round to 2 decimal places
            
            // Update originalSpeed to track the new font-size-based speed
            if (!isLongPressing) {
                originalSpeed = scrollSpeed;
            }
        }
        
        function startLongPress(action) {
            if (isLongPressing || longPressTimeout) return;
            
            longPressTimeout = setTimeout(() => {
                isLongPressing = true;
                lastAction = action;
                originalSpeed = scrollSpeed;
                
                if (action === 'ff') {
                    scrollSpeed = ffSpeed;
                    if (!isScrolling) {
                        toggleScrolling(); // Start playing if not already
                    }
                } else if (action === 'rw') {
                    scrollSpeed = rwSpeed;
                    if (!isScrolling) {
                        toggleScrolling(); // Start playing if not already
                    }
                }
                updateDisplays();
            }, longPressDelay);
        }
        
        function endLongPress() {
            if (longPressTimeout) {
                clearTimeout(longPressTimeout);
                longPressTimeout = null;
            }
            
            if (isLongPressing) {
                // Restore the actual speed that was set before FF/RW
                scrollSpeed = originalSpeed;
                
                // Compensate for the speed adjustment that happened before long press triggered
                if (lastAction === 'rw') {
                    scrollSpeed += 0.2; // Add back the 0.2 that was subtracted
                } else if (lastAction === 'ff') {
                    scrollSpeed -= 0.2; // Subtract the 0.2 that was added
                }
                
                isLongPressing = false;
                lastAction = null;
                updateDisplays();
            }
        }
        
        function toggleControls() {
            controlsVisible = !controlsVisible;
            controlsElement.classList.toggle('hidden', !controlsVisible);
            if (controlsVisible) {
                showControlsTemporarily();
            }
        }
        
        function updateControlsVisibility() {
            if (!controlsVisible) return;
            
            clearTimeout(hideTimeout);
            
            if (isScrolling) {
                // Hide controls 3 seconds after play starts
                controlsElement.classList.remove('hidden');
                hideTimeout = setTimeout(() => {
                    if (controlsVisible && isScrolling) {
                        controlsElement.classList.add('hidden');
                    }
                }, 3000);
            } else {
                // Show controls when paused
                controlsElement.classList.remove('hidden');
            }
        }
        
        function updateDisplays() {
            statusElement.textContent = isScrolling ? 'Playing' : 'Paused';
            statusElement.style.color = isScrolling ? '#4CAF50' : '#f44336';
            speedDisplay.textContent = scrollSpeed.toFixed(1) + 'x';
            fontSizeDisplay.textContent = fontSize + 'px';
            updateCenterButtonIcon();
        }
        
        // Keyboard event handler
        document.addEventListener('keydown', function(event) {
            switch(event.code) {
                case 'ArrowRight':
                    event.preventDefault();
                    activateDpadButton('dpad-right');
                    adjustFontSize(2);
                    break;
                case 'ArrowLeft':
                    event.preventDefault();
                    activateDpadButton('dpad-left');
                    adjustFontSize(-2);
                    break;
                case 'ArrowUp':
                    event.preventDefault();
                    activateDpadButton('dpad-up');
                    if (!longPressTimeout && !isLongPressing) {
                        adjustSpeed(-0.2);
                    }
                    startLongPress('rw');
                    break;
                case 'ArrowDown':
                    event.preventDefault();
                    activateDpadButton('dpad-down');
                    if (!longPressTimeout && !isLongPressing) {
                        adjustSpeed(0.2);
                    }
                    startLongPress('ff');
                    break;
                case 'Space':
                    event.preventDefault();
                    activateDpadButton('dpad-center');
                    toggleScrolling();
                    break;
                case 'KeyH':
                    event.preventDefault();
                    toggleControls();
                    break;
                case 'F5':
                    event.preventDefault();
                    if (!isScrolling) {
                        toggleScrolling();
                    }
                    break;
                case 'Escape':
                    event.preventDefault();
                    if (isScrolling) {
                        toggleScrolling();
                    }
                    break;
                case 'PageUp':
                    event.preventDefault();
                    if (!longPressTimeout && !isLongPressing) {
                        adjustSpeed(-0.2);
                    }
                    startLongPress('rw');
                    break;
                case 'PageDown':
                    event.preventDefault();
                    if (!longPressTimeout && !isLongPressing) {
                        adjustSpeed(0.2);
                    }
                    startLongPress('ff');
                    break;
                case 'Period':
                    event.preventDefault();
                    increaseFontSize();
                    break;
            }
        });
        
        // Handle key release for long press functionality
        document.addEventListener('keyup', function(event) {
            // Always end long press on any key release to be more reliable
            endLongPress();
            
            // Remove visual feedback from D-pad buttons
            switch(event.code) {
                case 'ArrowRight':
                    deactivateDpadButton('dpad-right');
                    break;
                case 'ArrowLeft':
                    deactivateDpadButton('dpad-left');
                    break;
                case 'ArrowUp':
                    deactivateDpadButton('dpad-up');
                    break;
                case 'ArrowDown':
                    deactivateDpadButton('dpad-down');
                    break;
                case 'Space':
                    deactivateDpadButton('dpad-center');
                    break;
            }
        });
        
        // Mouse movement shows controls (no effect on visibility logic)
        document.addEventListener('mousemove', () => {
            // Mouse movement doesn't affect control visibility in new logic
        });
        
        // Manual scrolling with trackpad/mouse wheel
        let manualScrollTimeout = null;
        let wasScrollingBeforeManual = false;
        
        document.addEventListener('wheel', function(event) {
            event.preventDefault(); // Prevent page scrolling
            
            // Pause automatic scrolling during manual scrolling
            if (isScrolling) {
                wasScrollingBeforeManual = true;
                isScrolling = false;
            }
            
            // Get current position
            const currentTop = parseFloat(scriptContent.style.top) || 180;
            
            // Calculate new position based on wheel delta
            const scrollSensitivity = 2; // Adjust sensitivity as needed
            const deltaY = event.deltaY * scrollSensitivity;
            const newTop = currentTop - deltaY;
            
            // Apply the new position
            scriptContent.style.top = newTop + 'px';
            
            // Clear existing timeout
            if (manualScrollTimeout) {
                clearTimeout(manualScrollTimeout);
            }
            
            // Resume automatic scrolling after 2 seconds of no manual scrolling
            manualScrollTimeout = setTimeout(() => {
                if (wasScrollingBeforeManual) {
                    isScrolling = true;
                    wasScrollingBeforeManual = false;
                }
            }, 2000);
        });
        
        // Prevent context menu on right click
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
        });
        
    </script>
</body>
</html>